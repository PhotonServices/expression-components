<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/x-websocket/dist/x-websocket.html">
<!--
A widget bar
-->
<polymer-element name="sentiment-ribbon" layout horizontal center attributes="cardid socket stats">
  <template>
    <template if="{{!stats}}">
    <style>
    :host{
      width: 100%;
      background: #FF8F29;
      color: white;
      height: 50px;
    }
    :host #text{
      width: 100%;
      font-weight: 300;
      font-size: 18px;
      color: white;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      cursor: pointer;
      opacity: 0.75;
      padding: 5px;
    }
  </style>
  <marquee id="text"></marquee>
  <x-websocket id="sentimentSocket"  url="{{socket}}"></x-websocket>
  <x-websocket id="folksonomySocket" url="{{socket}}"></x-websocket>
</template>
<!-- Template: statistics overall -->
<template if="{{stats}}">
<style>
:host{
  width: 100%;
  background: #FF8F29;
  color: white;
  height: 50px;
}
:host #text{
  width: 100%;
  font-weight: 300;
  font-size: 18px;
  color: white;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
  cursor: pointer;
  opacity: 0.75;
  padding: 5px;
}
</style>
<div id="text"></div>
<x-websocket id="sentimentSocket"  url="{{socket}}"></x-websocket>
</template>
</template>
<script>
Polymer('sentiment-ribbon', {
  attached: function(){
    var self= this.$;
    var ribbon = this;
    var stats = this.stats;
    var socket = this.socket;
    var cardid = this.cardid;
    var folksonomy = [];
    /*
    * Set the background accordinly to the sentiment.
    */
    self.sentimentSocket.addEventListener("open", function() {
      self.sentimentSocket.send('{"path":"events","message":"subscribe","content":"'+cardid+':sentiment-final"}');
    });
    self.sentimentSocket.addEventListener("message", function(event) {
      var cardname  = this.cardname;
      var sentiment = JSON.parse(event.detail.data).data;
      if(sentiment >= 0.5) {
        ribbon.style.backgroundColor = "#18B061";
      } else if (sentiment <= -0.5) {
        ribbon.style.backgroundColor = "#F52E43";
      } else if (sentiment < 0.5 && sentiment > -0.5){
        ribbon.style.backgroundColor = "#FF8F29";
      }
      if(stats){
        if(sentiment >= 0.5) {
          self.text.innerHTML = "El sentimiento es positivo.";
        } else if (sentiment <= -0.5) {
          self.text.innerHTML = "El sentimiento es negativo.";
        } else if (sentiment < 0.5 && sentiment > -0.5){
          self.text.innerHTML = "El sentimiento es neutro.";
        }
      }
    });
    /*
    * Folksonomy As default. By now.
    */
    var animation = new CoreAnimation();
    animation.duration = 1000;
    animation.keyframes = [{opacity: 0},{opacity: 1}];
    animation.target = self.left;
    /*
    * WebSocket event handler.
    */
    self.folksonomySocket.addEventListener("open", function() {
      self.folksonomySocket.send('{"path":"events","message":"subscribe","content":"'+cardid+':folksonomy-global:add"}');
    });
    self.folksonomySocket.addEventListener("message", function(event) {
      var data = JSON.parse(event.detail.data).data;
      if((data.substr(data.length-3) != "add")) {
        folksonomy[folksonomy.length] = data;
      }
      self.text.innerHTML  = folksonomy
      animation.play();
    });
  }
});
</script>
</polymer-element>
