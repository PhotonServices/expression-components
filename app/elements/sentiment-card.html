<!--
@license
The MIT License (MIT)

Copyright (c) 2014 The Photon Services Authors. All rights reserved.
This code may only be used under the BSD style license
found at http://opensource.org/licenses/MIT

-->
<!-- Sentiment Card View Component.
Author: Francisco GutiÃ©rrez (fsalvador23@gmail.com)
-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import" href="../bower_components/core-icons/maps-icons.html">
<link rel="import" href="../bower_components/core-icons/av-icons.html">
<link rel="import" href="../bower_components/core-icons/device-icons.html">
<link rel="import" href="../bower_components/core-icons/image-icons.html">
<link rel="import" href="../bower_components/core-icons/hardware-icons.html">
<link rel="import" href="../bower_components/x-websocket/dist/x-websocket.html">
<link rel="import" href="action-container.html">
<link rel="import" href="widget-sentiment-chart.html">
<link rel="import" href="widget-demography-counter.html">
<link rel="import" href="sentiment-ribbon.html">
<link href='//fonts.googleapis.com/css?family=Roboto:400,300,100' rel='stylesheet' type='text/css'>
<polymer-element
name="sentiment-card"
attributes="sentiment cardicon cardid cardname socket" flex auto>
<template>
<style>
/* Template CSS -
* Moving it into a separated SASS file when scaffolding into separate
* repositories.
*/
*:not(html) {
  -webkit-transform: translate3d(0, 0, 0);
}
:host {
  padding-left: 12px;
  padding-right: 12px;
  padding-top: 9px;
  padding-bottom: 9px;
  width: 300px;
  height:300px;
  font-family: 'Roboto','Helvetica', sans-serif;
  /** Make the backside clickable **/
  transform:translateZ(1px);
  -webkit-transform:translateZ(1px);
  -moz-transform:translateZ(1px);
  -webkit-font-smoothing: antialiased;
  border-radius: 5px;
}
:host #card {
  /*width:  300px;*/
  height:300px;
  /*Animation setup*/
  transition:        transform  0.5s;
  -moz-transition:   -moz-transform 0.5s;
  -webkit-transition:-webkit-transform 0.5s;
  transform-style:         preserve-3d;
  -moz-transform-style:    preserve-3d;
  -webkit-transform-style: preserve-3d;
  /* Make the backside clickable **/
  transform:translateZ(10px);
  -webkit-transform:translateZ(10px);
  -moz-transform:translateZ(10px);
  border-radius: 3px;
}
:host #card.flipped {
  transform:         rotateY(180deg) translateZ(1px);
  -moz-transform:    rotateY(180deg) translateZ(1px);
  -webkit-transform: rotateY(180deg) translateZ(1px);
}
:host #card.flippedBack {
  transform:         rotateY(0deg) translateZ(1px);
  -moz-transform:    rotateY(0deg) translateZ(1px);
  -webkit-transform: rotateY(0deg) translateZ(1px);
}
:host #card #front {
  /*width:  300px;*/
  border-radius: 5px;
  height:300px;
  backface-visibility:        hidden;
  -moz-backface-visibility:   hidden;
  -webkit-backface-visibility:hidden;
  transform:translateZ(1px);
  -webkit-transform:translateZ(1px);
  -moz-transform:translateZ(1px);
  cursor: pointer;
}
:host #card #back {
  border-radius: 5px;
  /*width:  300px;*/
  height:300px;
  backface-visibility:        hidden;
  -moz-backface-visibility:   hidden;
  -webkit-backface-visibility:hidden;
}
:host #card #back {
  border-radius: 5px;
  transform:         rotateY(180deg);
  -moz-transform:    rotateY(180deg);
  -webkit-transform: rotateY(180deg);
}
/*
* Polymer's Core-icon definition.
*/
:host #front #img {
  fill: white;
  width: 85%;
  height: 85%;
  display: block;
  margin: auto;
}
:host .title {
  margin: 15px;
  width: auto;
  font-weight: 100;
  font-size: 25px;
  color: white;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
  cursor: pointer;
}
:host widget-container{
  position:absolute;
  top:  40px;
  left: 20px;
}
:host action-container {
  position: absolute;
  right:  -17px;
  top:    -13px;
}
:host #widgetContainer {
  height: 65%;
}
:host #cardid{
  visibility: hidden;
  position: absolute;
}
#counter{
  position: absolute;
  bottom:10px;
  right:20px;
}
</style>
<div id="card" flex auto>
  <div id="cardid">{{cardid}}</div>
  <div id="front" select="front" vertical layout>
    <core-icon id="img" icon="{{cardicon}}"></core-icon>
    <sentiment-ribbon></sentiment-ribbon>
    <h1 id="frontTitle" class="title">{{cardname}}</h1>
  </div>
  <div id="back" vertical layout>
    <div id="widgetContainer" vertical layout center>
      <widget-sentiment-chart id="sentimentChart"
      on-tap = "{{sentimentTap}}"
      cardid = "{{cardid}}"
      socket = "{{socket}}"
      ></widget-sentiment-chart>
    </div>
    <action-container></action-container>
    <sentiment-ribbon></sentiment-ribbon>
    <h1 id="backTitle" class='title' on-tap="{{titleTapped}}">{{cardname}}</h1>
  </div>
  <paper-shadow z="1" id="myShadow" animated></paper-shadow>
</div>
<widget-demography-counter id="counter" on-tap = "{{counterTap}}" cardid = "{{cardid}}" socket = "{{socket}}"></widget-demography-counter>
<x-websocket id="cardSocket" url="{{socket}}" ></x-websocket>
</template>
<script>
Polymer("sentiment-card", {
  attached: function(){
    var self = this.$;
    var socket = this.socket;
    var cardid = this.cardid;
    /*
    * WebSocket event handler.
    */
    self.cardSocket.addEventListener("open", function() {
      /*** commented for testing purposes ***/
      self.cardSocket.send('{"path":"events","message":"subscribe","content":"'+cardid+':sentiment-final"}');
    });
    self.cardSocket.addEventListener("message", function(event) {
      var cardname  = this.cardname;
      var sentiment = this.sentiment;
      if(JSON.parse(event.detail.data).data >= 0.5) {
        self.front.style.backgroundColor = "#2ECC71";
        self.back.style.backgroundColor = "#2ECC71";
        /*
        * Next line causes a rendering bug when flipping the card in Chrome.
        * Version 37.0.2062.124 (Flickering)
        */
        self.card.style.backgroundColor = "#2ECC71";
      } else if (JSON.parse(event.detail.data).data <= -0.5) {
        self.front.style.backgroundColor = "#EA6153";
        self.back.style.backgroundColor = "#EA6153";
        /*
        * Next line causes a rendering bug when flipping the card in Chrome.
        * Version 37.0.2062.124 (Flickering)
        */
        self.card.style.backgroundColor = "#EA6153";
      } else {
        self.front.style.backgroundColor = "#FFA72B";
        self.back.style.backgroundColor = "#FFA72B";
        /*
        * Next line causes a rendering bug when flipping the card in Chrome.
        * Version 37.0.2062.124 (Flickering)
        */
        self.card .style.backgroundColor = "#FFA72B";
      }
    });
    /*
    * Attached, DOM lifecycle: check for the sentiment overall:
    */
    var cardname = this.cardname;
    var sentiment = this.sentiment;
    if(sentiment > 0.5) {
      self.front.style.backgroundColor = "#2ECC71";
      self.back.style.backgroundColor = "#2ECC71";
      /*
      * Next line causes a rendering bug when flipping the card in Chrome.
      * Version 37.0.2062.124 (Flickering)
      */
      // self.card.style.backgroundColor = "#2ECC71";
    } else if (sentiment < -0.5) {
      self.front.style.backgroundColor = "#EA6153";
      self.back.style.backgroundColor = "#EA6153";
      /*
      * Next line causes a rendering bug when flipping the card in Chrome.
      * Version 37.0.2062.124 (Flickering)
      */
      // self.card.style.backgroundColor = "#EA6153";
    } else {
      self.front.style.backgroundColor = "#FFA72B";
      self.back.style.backgroundColor = "#FFA72B";
      /*
      * Next line causes a rendering bug when flipping the card in Chrome.
      * Version 37.0.2062.124 (Flickering)
      */
      self.card .style.backgroundColor = "#FFA72B";
    }
    /*
    * Do the flip:
    */
    this.addEventListener("click", function() {
      self.card.className = "flipped";
      self.back.style.display = "block";
      self.front.style.display = "none";
    });
  },
  titleTapped: function (){
    var self = this.$;
    self.card.className = "flippedBack";
    self.back.style.display = "none";
    self.front.style.display = "block";
  }
});
</script>
</polymer-element>
